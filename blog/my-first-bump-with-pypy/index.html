<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My first bump with pypy | Cases</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (pl)" hreflang="pl" href="../../pl/rss.xml">
<link rel="canonical" href="http://blog.fizyk.net.pl/blog/my-first-bump-with-pypy/">
<link rel="icon" href="../../favicon.png" sizes="62x60">
<link rel="icon" href="../../favicon-speddial.png" sizes="269x262">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Grzegorz Śliwiński">
<link rel="prev" href="../reminder-set-pool_recycle-for-sqlalchemys-connection-to-mysql/" title="Reminder to use pool_recycle for SQLAlchemy's connection to mysql" type="text/html">
<link rel="next" href="../commit-a-day-will-scratch-your-itch-away/" title="Commit a day, will scratch Your itch away" type="text/html">
<meta property="og:site_name" content="Cases">
<meta property="og:title" content="My first bump with pypy">
<meta property="og:url" content="http://blog.fizyk.net.pl/blog/my-first-bump-with-pypy/">
<meta property="og:description" content="Just until two weeks ago, I was only reading about PyPy. My though about it was somewhat simple: that's the interpreter, that speeds up python code. I expected that some changes to python code, that's">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-08-21T22:34:42+02:00">
<meta property="article:tag" content="pypy">
<meta property="article:tag" content="python">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Cases</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item"><a href="../../pl/" rel="alternate" hreflang="pl" class="nav-link">Polski</a></li>

                    
                    
    
    <li class="nav-item">
    <a href="index.rst" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="http://www.fizyk.net.pl/en" class="nav-link">Homepage</a>
                </li>
<li class="nav-item">
<a href="../../archive/" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="../../tags/" class="nav-link">Tags</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">My first bump with pypy</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Grzegorz Śliwiński
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2014-08-21T22:34:42+02:00" itemprop="datePublished" title="21 8 2014 22:34">21 8 2014 22:34</time></a>
            </p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/2014-08-21-my-first-bump-with-pypy.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Just until two weeks ago, I was only reading about PyPy. My though about it was somewhat simple: that's the interpreter, that speeds up python code. I expected that some changes to python code, that's supposed to run in PyPy will be required, but I thought it will be easy to spot. I haven't been more wrong.</p>
<!-- TEASER_END -->
<p>I wanted to add PyPy's interpreters to mirakuru's tests on travis. I thought, that it will be more or less enough, to add PyPy and PyPy3 to travis.yml file. Well... One of the tests hanged, and I had no idea why.</p>
<p>For this test, we start a SimpleHTTPServer that's available in python, and wait, till it is started. But before it starts, be wait at the subprocess for 3 seconds.</p>
<pre class="code python"><a id="rest_code_16767e818a984461b82b095318dda48d-1" name="rest_code_16767e818a984461b82b095318dda48d-1"></a><span class="n">command</span> <span class="o">=</span> <span class="s1">'bash -c "sleep 3 &amp;&amp; python -m SimpleHTTPServer 7897"'</span>
<a id="rest_code_16767e818a984461b82b095318dda48d-2" name="rest_code_16767e818a984461b82b095318dda48d-2"></a>
<a id="rest_code_16767e818a984461b82b095318dda48d-3" name="rest_code_16767e818a984461b82b095318dda48d-3"></a><span class="n">executor</span> <span class="o">=</span> <span class="n">HTTPExecutor</span><span class="p">(</span>
<a id="rest_code_16767e818a984461b82b095318dda48d-4" name="rest_code_16767e818a984461b82b095318dda48d-4"></a>    <span class="n">command</span><span class="p">,</span> <span class="s1">'http://127.0.0.1:7897/'</span>
<a id="rest_code_16767e818a984461b82b095318dda48d-5" name="rest_code_16767e818a984461b82b095318dda48d-5"></a>    <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span>
<a id="rest_code_16767e818a984461b82b095318dda48d-6" name="rest_code_16767e818a984461b82b095318dda48d-6"></a><span class="p">)</span>
<a id="rest_code_16767e818a984461b82b095318dda48d-7" name="rest_code_16767e818a984461b82b095318dda48d-7"></a><span class="n">executor</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre>
<p>Inside of HTTPExecutor we've been waiting for process, to start responding on TCP connection first at the host and port in address passed to Executor:</p>
<pre class="code python"><a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-1" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-1"></a><span class="k">try</span><span class="p">:</span>
<a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-2" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-2"></a>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-3" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-3"></a>    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
<a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-4" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-4"></a>    <span class="k">return</span> <span class="kc">True</span>
<a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-5" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-5"></a><span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
<a id="rest_code_f151ad217f8e48a698c6a7a69000d0c3-6" name="rest_code_f151ad217f8e48a698c6a7a69000d0c3-6"></a>    <span class="k">return</span> <span class="kc">False</span>
</pre>
<p>And after that, for a successful head at the address passed:</p>
<pre class="code python"><a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-1" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-1"></a><span class="k">try</span><span class="p">:</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-2" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-2"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-3" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-3"></a>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-4" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-4"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">'HEAD'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-5" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-5"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-6" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-6"></a>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-7" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-7"></a>    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">OK</span><span class="p">:</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-8" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-8"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-9" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-9"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-10" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-10"></a>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-11" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-11"></a><span class="k">except</span> <span class="p">(</span><span class="n">HTTPException</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>
<a id="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-12" name="rest_code_163f7b62a2f64ee2b6c7f0f2f1362a33-12"></a>    <span class="k">return</span> <span class="kc">False</span>
</pre>
<p>And the code execution hanged just at the <cite>conn.getresponse()</cite> <em>I guess</em>. Unfortunately, when I tried to debug the code, it just worked, so I assume, debugging it, just turns off any optimisation PyPy is doing.</p>
<p>Few days later, a colleague of mine, <strong>Paweł Wilczyński</strong>, introduced checks before starting process, if ports are not already taken. It also reduced waits after starting to only check the HTTPConnection - and surprisingly tests started to pass.</p>
<p>At that time I still haven't got the slightest idea why pypy tests started to pass, and haven't before. So I started to play with the code instead of merging, and now, I think I know what happened.</p>
<p>Fault was ours, of course, and it was open socket, that have been left after the first check. Python must have been closing it, when it garbage collecting it, but PyPy's garbage collecting seems to be different - and left that socket open. Or PyPy just simply does not close the socket by itself, leaving it leaked.</p>
<p>Anyway, the solution was to fix first example by manually closing the socket in the end.</p>
<pre class="code python"><a id="rest_code_df3ca47df3494ccc9b67d81687db9c44-1" name="rest_code_df3ca47df3494ccc9b67d81687db9c44-1"></a><span class="k">finally</span><span class="p">:</span>
<a id="rest_code_df3ca47df3494ccc9b67d81687db9c44-2" name="rest_code_df3ca47df3494ccc9b67d81687db9c44-2"></a>    <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/pypy/" rel="tag">pypy</a></li>
            <li><a class="tag p-category" href="../../tags/python/" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../reminder-set-pool_recycle-for-sqlalchemys-connection-to-mysql/" rel="prev" title="Reminder to use pool_recycle for SQLAlchemy's connection to mysql">Previous post</a>
            </li>
            <li class="next">
                <a href="../commit-a-day-will-scratch-your-itch-away/" rel="next" title="Commit a day, will scratch Your itch away">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="casesblog",
            disqus_url="http://blog.fizyk.net.pl/blog/my-first-bump-with-pypy/",
        disqus_title="My first bump with pypy",
        disqus_identifier="cache/posts/2014-08-21-my-first-bump-with-pypy.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="casesblog";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2021 <a href="mailto:fizyk~~fizyk.net.pl">Grzegorz Śliwiński</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20536007-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
