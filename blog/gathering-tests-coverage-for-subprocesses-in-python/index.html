<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Gathering tests coverage for subprocesses in python | Cases</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (pl)" href="../../pl/rss.xml">
<link rel="canonical" href="https://fizyk.dev/blog/gathering-tests-coverage-for-subprocesses-in-python/">
<link rel="icon" href="../../favicon-speddial.png" sizes="269x262">
<link rel="icon" href="../../favicon.png" sizes="62x60">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
</head>
<body class="home blog">
    <div id="wrap" style="width:850px">
        <div id="container" style="width:560px">
            
            
    <div class="post">
    
    <h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Gathering tests coverage for subprocesses in python</a></h1>

        <div class="meta" style="background-color: rgb(234, 234, 234); ">
        <span class="authordate">
            Posted: <time class="published" datetime="2013-10-27T20:22:05+01:00">27 10 2013 20:22</time>
               [<a href="index.rst" id="sourcelink">Source</a>]
        </span>
        <br><span class="tags">Tags: 
                    <a class="tag" href="../../tags/coverage/"><span>coverage</span></a>
                    <a class="tag" href="../../tags/pytest/"><span>pytest</span></a>
                    <a class="tag" href="../../tags/python/"><span>python</span></a>
                    <a class="tag" href="../../tags/testing/"><span>testing</span></a>
                </span>
                <br><span class="authordate">
            

        </span>
        </div>
    <p>Recently at work I've stumbled across quite a problem, how do You check your code coverage, especially in integration tests, when portions of your code are running as subprocesses?</p>
<p>tl;dr: Be gentle.</p>
<!-- TEASER_END -->
<p>The answer wasn't obvious, but got first hint, in Ned Batchelder's, creator of coverage.py, <a class="reference external" href="http://nedbatchelder.com/blog/201001/running_code_at_python_startup.html">Running code at Python startup</a> blog post. Took me a while, since it was my first encounter with both ways <strong>sitepackages.py</strong> and <strong>.pth</strong>. Tried both of them, and got nothing, except for my Powerline Shell installation picking up code from the <strong>sitepackages.py</strong> file on each command entered into bash.</p>
<p>Well, just my luck. Since the solution written by Ned, utilizes Environmental variable, I tried to make sure subprocesses got the same variables from master process, and even checked what do they got. Everything seemed okay at this end, especially that we already used some environmental variable for settings, and test settings were picked up by subprocess.</p>
<p>Since we use <a class="reference external" href="https://pypi.python.org/pypi/pytest">pytest</a> testing suite for testing and <a class="reference external" href="https://pypi.python.org/pypi/pytest-cov">pytest-cov</a> plugin for gathering code coverage, I looked deeper at the plugins readme. Well... it says that it has code coverage for subprocess already built-in. Quick look at source of pytest-cov and cov-core made me realize, that I needlessly tried to use basic coverage.py functionality, as cov-core package already utilises the <strong>.pth</strong> way, although customized.</p>
<p>We use <a class="reference external" href="https://pypi.python.org/pypi/summon_process">summon_process</a> package to start subprocesses within pytest fixtures, which in turn, uses subprocess.Popen inside, so I took a look at the plugin, and tried to start subprocesses in it's own shell.</p>
<div class="code"><pre class="code python"><a id="rest_code_13ec0c06836c4aec8b440da41935c1fe-1" name="rest_code_13ec0c06836c4aec8b440da41935c1fe-1" href="#rest_code_13ec0c06836c4aec8b440da41935c1fe-1"></a><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>I was suprised to see it working, BUT... some tests failed and at the end I got a nasty database lock, which made me forcefully end test session. Damn. Trying to figure out how to get rid of the lock took me nowhere. It ceratinly was the foult within the other plugin <a class="reference external" href="https://pypi.python.org/pypi/pytest-dbfixtures">pytet-dbfixtures</a> as me and my friend in the team initially thought. Database wasn't the problem either, so what was? Well we haven't been waiting for terminating of the process. But starting subprocess in it's own shell, certainly did help.</p>
<p>Quick modification of the summon_process locally and installation of thismodified package and... nothing. Same problem. I looked up at the process list, and saw that we have as many subprocesses, as there was tests requireing their fixtures. What?</p>
<p>As it turns out, when you try to kill subprocess started with shell=True, you kill the shell, subprocess doesn't get signal. Quick modification again, creating process group and sending signal to the process group as described in this <a class="reference external" href="http://stackoverflow.com/questions/4789837/how-to-terminate-a-python-subprocess-launched-with-shell-true">stackoverflow question</a>. Quick modification and the code should change from:</p>
<div class="code"><pre class="code python"><a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-1" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-1" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-2" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-2" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-2"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-3" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-3" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-4" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-4" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-4"></a>                                         <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shell</span><span class="p">,</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-5" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-5" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-5"></a>                                         <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-6" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-6" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-6"></a>                                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-7" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-7" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-7"></a>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-8" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-8" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-9" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-9" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-9"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-10" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-10" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
<a id="rest_code_6dc34ccd740d44ed8d9c6045031442fb-11" name="rest_code_6dc34ccd740d44ed8d9c6045031442fb-11" href="#rest_code_6dc34ccd740d44ed8d9c6045031442fb-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
<p>to:</p>
<div class="code"><pre class="code python"><a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-1" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-1" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-2" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-2" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-2"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-3" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-3" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-4" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-4" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-4"></a>                                         <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shell</span><span class="p">,</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-5" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-5" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-5"></a>                                         <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-6" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-6" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-6"></a>                                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-7" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-7" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-7"></a>                                         <span class="n">preexec_fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">)</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-8" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-8" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-8"></a>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-9" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-9" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-10" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-10" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-10"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-11" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-11" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-11"></a>        <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-12" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-12" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<a id="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-13" name="rest_code_20d4a085a75b464bb67c46f4f8d8ca42-13" href="#rest_code_20d4a085a75b464bb67c46f4f8d8ca42-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
<p>Should work, right? And it did. I got rid from faulty test runs, got rid from databse lock, and... got rid of subprocess coverage! What?!</p>
<p>At this moment, I had to take a break from the problem, but let me tell you if you can't solve a problem, take a break.</p>
<p>Got back to it few days later. Totally resigned started with reading all pytest-cov issues. Those closed ones And found issue about <a class="reference external" href="https://bitbucket.org/memedough/pytest-cov/issue/6/coverage-not-collected-for">coverage not collected for multiprocesses</a>. Quite related. What does it say? That the coverage writes it data at the END of the process run, so starting process in reality first starts your coverage, then process. After the process ends, coverage writes it's data, which in turns gets picked up by coverage in master process, when it ends, and lands combined in the main coverage report.</p>
<p>So... how do we end the subprocess? We used terminate(). How does it ends the process? let check the <a class="reference external" href="http://man7.org/linux/man-pages/man7/signal.7.html">system signals man pages</a>. Damn... it terminates process in place, so the coverage doesn't have the chance to write it's subreports!</p>
<p>I've modified the original stop method from summon_process package into this:</p>
<div class="code"><pre class="code python"><a id="rest_code_12a6beab9bb4435e8caddaeecfd1a944-1" name="rest_code_12a6beab9bb4435e8caddaeecfd1a944-1" href="#rest_code_12a6beab9bb4435e8caddaeecfd1a944-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_12a6beab9bb4435e8caddaeecfd1a944-2" name="rest_code_12a6beab9bb4435e8caddaeecfd1a944-2" href="#rest_code_12a6beab9bb4435e8caddaeecfd1a944-2"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_12a6beab9bb4435e8caddaeecfd1a944-3" name="rest_code_12a6beab9bb4435e8caddaeecfd1a944-3" href="#rest_code_12a6beab9bb4435e8caddaeecfd1a944-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
<a id="rest_code_12a6beab9bb4435e8caddaeecfd1a944-4" name="rest_code_12a6beab9bb4435e8caddaeecfd1a944-4" href="#rest_code_12a6beab9bb4435e8caddaeecfd1a944-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<a id="rest_code_12a6beab9bb4435e8caddaeecfd1a944-5" name="rest_code_12a6beab9bb4435e8caddaeecfd1a944-5" href="#rest_code_12a6beab9bb4435e8caddaeecfd1a944-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
<p>And it worked! We didn't even had to start them with their own shell (starting subprocess with shells allowed for some of them to end correctly when killing main test thread).</p>
<p>So, the solution to <em>how gather coverage for subprocess</em> question is to <strong>terminate them gently</strong>. Well... <a class="reference external" href="http://vimeo.com/44725028">Tenacious D is right</a> again ;)</p>
<p>PS. Solving this problem resulted in <a class="reference external" href="https://github.com/mlen/summon_process/pull/3/files">pull request for summon_process package</a></p>
    
        <ul class="pager hidden-print">
<li class="previous">
                <a href="../pyramid_fullauth-020/" rel="prev" title="pyramid_fullauth 0.2.0">Previous post</a>
            </li>
            <li class="next">
                <a href="../easy-way-to-debug-email-communication-in-python/" rel="next" title="Easy way to debug email communication in python">Next post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="casesblog",
            disqus_url="https://fizyk.dev/blog/gathering-tests-coverage-for-subprocesses-in-python/",
        disqus_title="Gathering tests coverage for subprocesses in python",
        disqus_identifier="cache/posts/2013-10-27-gathering-tests-coverage-for-subprocesses-in-python.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


    

    </div>

        </div>
        <div id="sidebar">
            <!--Sidebar content-->
            <h1 id="blog-title">
                <a href="https://fizyk.dev/" title="Cases">Cases</a>
            </h1>
            
            <small>
                Also available in: 
                
            <li><a href="https://fizyk.dev/pl/" rel="alternate" hreflang="pl">Polski</a></li>

            </small>
            
            <ul class="unstyled">
<li>
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.pl">
    <img alt="Licencja Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/88x31.png"></a>
<br>Ten utwór, autorstwa
<span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">
    Grzegorz Śliwiński</span>
jest dostępny na licencji
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.pl">
    Creative Commons Uznanie autorstwa 3.0 Unported
</a>.</li>
            
                <li>
<a href="https://fizyk.dev/en">Homepage</a>
                </li>
<li>
<a href="../../archive/">Archives</a>
                </li>
<li>
<a href="../../tags/">Tags</a>

            </li>
<li>
            
            
            </ul>
</div>
        <div id="footer">
            Contents © 2025 <a href="mailto:fizyk~~fizyk.dev">Grzegorz Śliwiński</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
            
        </div>
    </div>
    
            <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20536007-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
